var _=require("underscore"),FormGenerator={create:function(e,t,a,r){return React.createElement(FormGeneratorForm,{schema:e,ref:t,onSubmit:a,validateOnSubmit:r})},generate:function(e,t,a,r){if(_.isArray(e))return[React.createElement(ArrayField,{ref:n,schema:e[0],onChange:a})];var s=[];for(var n in e){var i=e[n];t=t||{};var l=i.defaultValue||t[n]||"";"object"==typeof i.type?i.type.length&&1===i.type.length?s.push(React.createElement(ArrayField,{ref:n,label:i.label,schema:i.type[0],onChange:a,defaultValue:l,validateOnSubmit:r})):s.push(React.createElement(ObjectField,{ref:n,label:i.label,schema:i.type,onChange:a,defaultValue:l,validateOnSubmit:r})):s.push(this.generateFlatField(n,i,l,a,r))}return s},generateFlatField:function(e,t,a,r,s){var n=t.validators||t.validate&&[t.validate]||[];if(t.hidden)return React.createElement(FlatField,{type:"hidden",ref:e,defaultValue:a});if(t.type===String||t.type===Number){if(t["enum"]){var i=_.isArray(t["enum"]);return React.createElement(FlatField,{type:"select",ref:e,label:t.label||"",placeholder:t["enum"][0]||"",defaultValue:a||t["enum"][0],children:_.map(t["enum"],function(e,t){return React.createElement("option",{value:i?e:t},e)}),validators:n,onChange:r,isRequired:t.isRequired,validateOnSubmit:s})}return React.createElement(FlatField,{type:t.isPassword?"password":"text",ref:e,label:t.label,placeholder:t.label||"",defaultValue:a,validators:n,onChange:r,isRequired:t.isRequired,isNumerical:t.type===Number,validateOnSubmit:s})}if(t.type===Boolean)return React.createElement(FlatField,{type:"checkbox",label:t.label,ref:e,defaultValue:a,validators:n,onChange:r,isRequired:t.isRequired,validateOnSubmit:s});if(t.type===Date)return React.createElement(FlatField,{type:"date",label:t.label,ref:e,defaultValue:a,validators:n,onChange:r,isRequired:t.isRequired,validateOnSubmit:s});throw"Unsupported type"},validators:{lengthEquals:function(e){return function(t){return(t||"").length!==e?"Error: must be of length "+e:null}},minLength:function(e){return function(t){return(t||"").length<e?"Error: must be at least "+e+" characters":null}},maxLength:function(e){return function(t){return(t||"").length>e?"Error: must be less than "+(e+1)+" characters":null}},regex:function(e){return function(t){return(t||"").match(e)?null:"Error: invalid input"}},nonEmpty:function(){return function(e){return e?null:"Error: field is required"}},number:function(){return function(e){return isNaN(e)?"Error: value must be numerical":null}}}},FormGeneratorForm=React.createClass({displayName:"FormGeneratorForm",propTypes:{schema:React.PropTypes.object.isRequired,onSubmit:React.PropTypes.func,defaultValue:React.PropTypes.object,label:React.PropTypes.string,validateOnSubmit:React.PropTypes.bool},getDefaultProps:function(){return{label:"",onSubmit:function(){}}},getInitialState:function(){return{isValid:!0,validateOnSubmit:this.props.validateOnSubmit}},onChange:function(){var e=this;setTimeout(function(){e.setState({isValid:e.isValid()})},100)},onSubmit:function(){if(this.state.validateOnSubmit&&!this.state.isValid)return this.setState({validateOnSubmit:!1},this.showErrorMessages);var e=this.props.onSubmit;e&&e(this.getValue())},getValue:function(){return this.refs.toplevelForm.getValue()},setValue:function(e){this.refs.toplevelForm.setValue(e)},reset:function(){this.refs.toplevelForm.reset()},isValid:function(){return this.refs.toplevelForm.isValid()},showErrorMessages:function(){this.refs.toplevelForm.showErrorMessages()},render:function(){var e=this.state.validateOnSubmit?!1:!this.state.isValid;return React.createElement("form",null,React.createElement(ObjectField,{ref:"toplevelForm",schema:this.props.schema,defaultValue:this.props.defaultValue,label:this.props.label,onChange:this.onChange,validateOnSubmit:this.state.validateOnSubmit}),React.createElement(ReactBootstrap.Button,{bSize:"large",onClick:this.onSubmit,disabled:e},"Submit"))}}),ObjectField=React.createClass({displayName:"ObjectField",propTypes:{schema:React.PropTypes.object.isRequired,onChange:React.PropTypes.func.isRequired,label:React.PropTypes.string,defaultValue:React.PropTypes.object,validateOnSubmit:React.PropTypes.bool},getDefaultProps:function(){return{label:""}},getInitialState:function(){return{}},getValue:function(){var e=this;return _.mapObject(this.props.schema,function(t,a){return e.refs[a].getValue()})},setValue:function(e){var t=this.refs;for(var a in this.props.schema)t[a].setValue(e[a])},reset:function(){for(var e in this.props.schema)this.refs[e].reset()},onChange:function(){this.props.onChange()},isValid:function(){var e=!0;for(var t in this.props.schema)e=e&&this.refs[t].isValid();return e},showErrorMessages:function(){for(var e in this.props.schema)this.refs[e].showErrorMessages()},render:function(){var e=FormGenerator.generate(this.props.schema,this.props.defaultValue,this.props.onChange,this.props.validateOnSubmit);return React.createElement(ReactBootstrap.Panel,{header:this.props.label},e)}}),ArrayField=React.createClass({displayName:"ArrayField",propTypes:{schema:React.PropTypes.oneOfType([React.PropTypes.func,React.PropTypes.object]).isRequired,onChange:React.PropTypes.func.isRequired,label:React.PropTypes.string,initialLength:React.PropTypes.number,validateOnSubmit:React.PropTypes.bool},getDefaultProps:function(){return{defaultValue:[],label:"",initialLength:1,refPrefix:"array_ref"}},getInitialState:function(){var e=function(e){return 0>e?0:e},t=e(this.props.defaultValue.length),a=e(this.props.initialLength),r=t||a||1;return{size:r}},getValue:function(){var e=this,t=this.props.refPrefix,a=[];return _.times(this.state.size,function(r){a.push(e.refs[t+r].getValue())}),a},setValue:function(e){var t=this.refs;this.setState({size:e.length||1},function(){var a=this.props.refPrefix;_.each(e,function(e,r){t[a+r].setValue(e)})})},reset:function(){this.setValue(this.props.defaultValue)},isValid:function(){var e=this,t=this.props.refPrefix,a=!0;return _.times(this.state.size,function(r){a=a&&e.refs[t+r].isValid()}),a},showErrorMessages:function(){var e=this,t=this.props.refPrefix;_.times(this.state.size,function(a){e.refs[t+a].showErrorMessages()})},addField:function(){this.setState({size:this.state.size+1})},removeField:function(){var e=this.state.size-1;this.setState({size:e||1})},render:function(){var e=this,t=this.props.schema,a=this.props.refPrefix,r=this.props.defaultValue,s=this.props.onChange,n=this.props.validateOnSubmit,i=[];return _.times(this.state.size,function(l){var o=r&&r[l]||"",u=a+l;if("function"==typeof t){var p={type:t,label:e.props.label,defaultValue:o};i.push(FormGenerator.generateFlatField(u,p,o,s,n))}else{var c={};c[u]={type:t,defaultValue:o},i.push(FormGenerator.generate(c,o,s,n))}}),React.createElement("div",null,React.createElement(ReactBootstrap.Panel,{header:e.props.label},i,React.createElement(ReactBootstrap.Button,{bsStyle:"primary",bsSize:"xsmall",onClick:e.addField},"Add"),React.createElement(ReactBootstrap.Button,{bsStyle:"primary",bsSize:"xsmall",onClick:e.removeField},"Remove")))}}),FlatField=React.createClass({displayName:"FlatField",propTypes:{type:React.PropTypes.string,label:React.PropTypes.string,placeholder:React.PropTypes.string,children:React.PropTypes.array,defaultValue:React.PropTypes.string,validators:React.PropTypes.arrayOf(React.PropTypes.func),onChange:React.PropTypes.func,isRequired:React.PropTypes.bool,isNumerical:React.PropTypes.bool,isPassword:React.PropTypes.bool,validateOnSubmit:React.PropTypes.bool},getDefaultProps:function(){return{type:"text",label:"",placeholder:"",children:[],validators:[],onChange:function(){},defaultValue:"",isRequired:!1,isNumerical:!1}},getInitialState:function(){return{value:this.props.defaultValue||"",errorMessages:[]}},componentDidMount:function(){var e=this.props.validateOnSubmit?[]:this.validate(this.getValue());this.setState({errorMessages:e}),this.props.onChange()},validate:function(e){var t=this.props.validators;return t=this.props.isRequired?t.concat([FormGenerator.validators.nonEmpty()]):t,t=this.props.isNumerical?t.concat([FormGenerator.validators.number()]):t,_.compact(_.map(t,function(t){return t(e)}))},isValid:function(){return!this.validate(this.getValue()).length},showErrorMessages:function(){this.setState({errorMessages:this.validate(this.getValue())})},getValue:function(){return this.state.value},setValue:function(e){var t=this.props.validateOnSubmit?[]:this.validate(this.getValue());this.setState({value:e,errorMessages:t},this.props.onChange)},reset:function(){this.setValue(this.props.defaultValue)},onChange:function(e){var t="checkbox"===this.props.type?!this.state.value:e.target.value;this.setValue(t)},render:function(){var e=this.state.errorMessages.length?" has-error":"";return function(t){switch(t.props.type){case"text":case"password":return React.createElement("div",{className:"form-group"+e},React.createElement("label",{className:"control-label"},t.props.label),React.createElement("input",{className:"form-control",type:t.props.type,label:t.props.label,placeholder:t.props.placeholder,onChange:t.onChange,value:t.state.value}),_.map(t.state.errorMessages,function(e){return React.createElement("span",{className:"help-block"},e)}));case"checkbox":return React.createElement(ReactBootstrap.Input,{type:t.props.type,label:t.props.label,placeholder:t.props.placeholder,onChange:t.onChange,checked:t.getValue()});case"select":return React.createElement(ReactBootstrap.Input,{type:t.props.type,label:t.props.label,placeholder:t.props.placeholder,onChange:t.onChange,value:t.state.value},t.props.children);case"date":throw"Unimplemented";case"hidden":return null}}(this)}});window.FormGenerator=FormGenerator;